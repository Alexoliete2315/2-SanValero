CREATE TABLE T_liquidacion (
    APELLIDO VARCHAR2(30) NOT NULL,
    DEPARTAMENTO VARCHAR2(30) NOT NULL,
    OFICIO VARCHAR2(30) NOT NULL,
    SALARIO NUMBER(8,2) NOT NULL,
    TRIENIOS NUMBER(8,2) NOT NULL,
    COMP_RESPONSABILIDAD NUMBER(8,2) NOT NULL,
    COMISION NUMBER(8,2) NOT NULL,
    TOTAL NUMBER(8,2) NOT NULL
);
CREATE OR REPLACE PROCEDURE tabla_LIQUI AS
    CURSOR MIS_EMPLES IS
        SELECT EMP_NO, APELLIDO, (SELECT DNOMBRE FROM DEPART WHERE DEPT_NO = E.DEPT_NO) DEPARTAMENTO, 
        OFICIO, SALARIO, FECHA_ALT, COMISION, (SELECT COUNT(*) FROM EMPLE WHERE E.EMP_NO = DIR) RESPONSABLE_DE
        FROM EMPLE E;
    V_TRIENIO NUMBER(6,2);
    V_RESPONSA NUMBER(6);
    V_COMISION NUMBER(4);
    V_TOTAL NUMBER(6); 
BEGIN
    FOR V_CADA_EMPLE IN MIS_EMPLES LOOP
        --CALCULOS
        V_TRIENIO := (TRUNC((SYSDATE - V_CADA_EMPLE.FECHA_ALT) / 365.25)) * 50;
        V_RESPONSA := 100 * V_CADA_EMPLE.RESPONSABLE_DE;
        V_COMISION := NVL(V_CADA_EMPLE.COMISION, 0);
        V_TOTAL := V_CADA_EMPLE.SALARIO + V_COMISION + V_RESPONSA + V_TRIENIO;
        
        INSERT INTO T_liquidacion (APELLIDO, DEPARTAMENTO, OFICIO, SALARIO, TRIENIOS, COMP_RESPONSABILIDAD, COMISION, TOTAL)
        VALUES (V_CADA_EMPLE.APELLIDO, V_CADA_EMPLE.DEPARTAMENTO, V_CADA_EMPLE.OFICIO, V_CADA_EMPLE.SALARIO,
                V_TRIENIO, V_RESPONSA, V_COMISION, V_TOTAL);
    END LOOP;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR');
END tabla_LIQUI;
/
